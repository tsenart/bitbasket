<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>BitBasket</title>
  <link href="http://fonts.googleapis.com/css?family=Neucha" rel="stylesheet" type="text/css">
  <link href="css/bitbasket.css" rel="stylesheet" type="text/css">
  <script src="js/underscore.js" type="text/javascript"></script>
</head>
<body>
  <img id="bit" src="imgs/icons/bit.png" title="All your base belongs to us.">
  <canvas id="basket">
    Your browser does not support the canvas tag.
  </canvas>
  <script type="text/javascript">
    var canvas = document.getElementById('basket');
    var socket = new WebSocket('ws://' + document.location.host);
    var ctx = canvas.getContext('2d');
    var iconSize = [50, 50]; 
    var step = 15;
    var offset = [0, 0];
    var speed = {38: [0, step, 0], 37: [step, 0, 0], 40: [0, -step, 0], 39: [-step, 0, 0]};
    var bits = [];
    var defaultIcon = document.getElementById('bit');
    var uid = '';
    
    function wipeCanvas(){
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    
    function updateBits(){
      _(speed).each(function(v, k){
        if(v[2] == 1){ // If active add to bits.
          _(bits).each(function(bit){
            bit.coords.x += v[0]; // x
            bit.coords.y += v[1]; // y
          });
          
          offset[0] += v[0]; 
          offset[1] += v[1];
        }
        
      });
    }
    
    function drawCanvas(){
      _(bits).each(function(bit){
        var icon = new Image();
        icon.src = 'imgs/icons/' + bit.file.name.split('.').pop() + '.png';
        icon.onload = function(e) {
          var img = icon;
          if(img.width == 0) img = defaultIcon;
          ctx.drawImage(img, bit.coords.x - (iconSize[0] / 2), bit.coords.y - (iconSize[1] / 2));
        }
      });
    }
    
    function cursorOnBit(e){
      return _(bits).any(function(bit) {
        return e.x < bit.coords.x + (iconSize[0] / 2)  &&
               e.x > bit.coords.x - (iconSize[0] / 2)  &&
               e.y < bit.coords.y + (iconSize[1] / 2)  &&
               e.y > bit.coords.y - (iconSize[1] / 2);
      });
    }
    
    function bitOnCursor(e) {
      return _(bits).filter(function(bit) {
        return e.x < bit.coords.x + (iconSize[0] / 2)  &&
               e.x > bit.coords.x - (iconSize[0] / 2)  &&
               e.y < bit.coords.y + (iconSize[1] / 2)  &&
               e.y > bit.coords.y - (iconSize[1] / 2);
      });
    }
     
    function noop(e) {
      e.stopPropagation();
      e.preventDefault();
    }
    
    window.onresize = window.onload = function(e){ wipeCanvas(); drawCanvas(); };   
    window.onbeforeunload = function(e){
      socket.send(JSON.stringify({uid:uid, del:true}));
    }
    document.onkeydown = function(e){
      if(speed[e.keyCode]) speed[e.keyCode][2] = 1;
      updateBits(); wipeCanvas(); drawCanvas(); 
    };
    document.onkeyup = function(e){ if(speed[e.keyCode]) speed[e.keyCode][2] = 0; };
    
    canvas.onmousemove = function(e) {
      if(cursorOnBit(e))
        document.body.style.cursor = 'pointer';
      else
        document.body.style.cursor = 'default';
    };
    
    canvas.onclick = function(e) {
      noop.apply(this, arguments);
      if(cursorOnBit(e)) {
        var bit = bitOnCursor(e)[0];
        document.location.replace('http://' + document.location.host + '/' + encodeURIComponent(bit.uid) + '/' + encodeURIComponent(bit.file.name));
      }
    };
    
    document.onkeypress = canvas.ondragenter = canvas.ondragover = canvas.ondragexit = noop;
    canvas.ondrop = function(e) {
      noop.apply(this, arguments);      
      var dropedfile = e.dataTransfer.files[0];
      var reader = new FileReader();
      var bit = {
        uid: uid,
        file: {
          name: dropedfile.name,
          size: dropedfile.size,
          type: dropedfile.type,
        },
        coords: {x: e.x, y: e.y},
      };
      
      console.log('Droped file at ('+ bit.coords.x +','+ bit.coords.y +')');
      console.log('Current offset: ('+ offset[0] +','+ offset[1] +')')
      bits.push(bit);
      wipeCanvas();
      drawCanvas();
            
      reader.onloadend = function(e) {        
        socket.send(JSON.stringify({
          uid: uid,
          file: {
            name: dropedfile.name,
            size: dropedfile.size,
            type: dropedfile.type,
            data: btoa(e.target.result)
          },
          coords: {x: bit.coords.x - offset[0], y: bit.coords.y - offset[1]}
        }));
      };
      reader.readAsBinaryString(dropedfile);
    };
    
    // NETWORKING
    socket.onmessage = function(data) {
      var msg = JSON.parse(data.data);
      console.log('WS Activity:')
      msg.length = _(msg).keys().length;
      if(msg.length == 1 && msg.uid) {
        uid = msg.uid;
        console.log('You are a new client with id: ' + uid);
      }
      
      if(msg.length == 3 && msg.coords && msg.file && msg.uid != uid) {
        msg.coords.x += offset[0];
        msg.coords.y += offset[1];
        bits.push(msg);
        console.log('Got new bit from server:');
        console.log('  ' + msg.uid);
        console.log('  ' + msg.file.name);
      }
      
      if(msg.del) {
        bits = _(bits).filter(function(b){ return b.uid != msg.uid });
        console.log('Client "' + msg.uid + '" disconnected from server. Removing his bits...');
      }
      wipeCanvas();
      drawCanvas();
    };
        
  </script>
</body>
</html>